---
import Base from "@layouts/Base.astro";
import {
  allServicePagesQuery,
  serviceQuery,
  siteConfigQuery,
} from "@api/queries";
import { imageBuilder, loadQuery } from "@api/sanity";
import SanityComponentsRenderer from "@components/cms-components/SanityComponentsRenderer.astro";
import { type ServiceWithReferences } from "src/sanity/custom.sanity.types";
import HeroHeader from "@components/uicomposition/HeroHeader.astro";
import Customers from "@components/uicomposition/Customers.astro";
import type {
  AllServicePagesQueryResult,
  SiteConfigQueryResult,
} from "@sanity/sanity.types";
import { VISUAL_EDITING_ENABLED } from "@src/consts";
import { locales } from "@src/locales/consts";
import type { Image } from "sanity";

const locale = Astro.currentLocale!;

export async function getStaticPaths() {
  if (!VISUAL_EDITING_ENABLED) {
    let pages: { params: { slug: string; locale: string } }[] = [];

    for (const language of locales) {
      const { data: services } = await loadQuery<AllServicePagesQueryResult>({
        query: allServicePagesQuery,
        params: { language },
      });

      const slugs = services.map((slug) => ({
        params: { slug: slug!, locale: language },
      }));
      pages = pages.concat(slugs);
    }

    return pages;
  } else {
    return [];
  }
}

const { slug } = Astro.params;

const { data: siteConfig } = await loadQuery<SiteConfigQueryResult>({
  query: siteConfigQuery,
  params: { language: locale },
});

if (!siteConfig) {
  return new Response(null, { status: 404 });
}

const { data: servicePage } = await loadQuery<ServiceWithReferences>({
  query: serviceQuery,
  params: { language: locale, slug: slug! },
});

if (servicePage == null) {
  return new Response(null, { status: 404 });
}
---

<Base
  title={`${servicePage?.metadata?.title || servicePage?.intro?.title!} - ${siteConfig.siteName}`}
  description={servicePage?.metadata?.description || ""}
  slug={slug!}
  siteConfig={siteConfig}
  routeMap="services"
  translations={servicePage?._translations}
  noIndex={servicePage?.metadata?.noIndex}
  seoImage={servicePage?.metadata?.image as Image}
>
  <HeroHeader
    headline={servicePage.intro?.title}
    text={servicePage.intro?.intro}
    backgroundImage={servicePage?.image?.asset?._id}
  >
    {
      servicePage.customerReferences &&
        servicePage.customerReferences.length > 0 && (
          <Customers headline={servicePage.customerReferencesText}>
            {servicePage.customerReferences?.map((customer: any) => (
              <>
                {customer?.logo?.light?.asset && (
                  <img
                    src={imageBuilder
                      .image(customer.logo.light.asset)
                      .height(80)
                      .url()}
                    alt={customer.logo.light.asset.altTexts?.[locale] || ""}
                    class="h-10 w-auto"
                  />
                )}
              </>
            ))}
          </Customers>
        )
    }
  </HeroHeader>
  <SanityComponentsRenderer content={servicePage?.content} />
</Base>
