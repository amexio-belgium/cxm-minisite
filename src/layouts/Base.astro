---
import BaseHead from "@components/layoutcomponents/BaseHead.astro";
import Header from "@components/layoutcomponents/Header.astro";
import Footer, { type Social } from "@components/layoutcomponents/Footer.astro";
import TrackingFooter from "@components/uielements/TrackingFooter.astro";
import Tracking from "@components/uielements/Tracking.astro";
import { navigationQuery } from "src/api/queries";
import type {
  NavigationQueryResult,
  SiteConfigQueryResult,
} from "src/sanity/sanity.types";
import { loadQuery } from "src/api/sanity";
import { VisualEditing } from "@sanity/astro/visual-editing";
import { getHrefFromLinkObject } from "@lib/sanityHelpers";
import I18nClient from "@astrolicious/i18n/components/I18nClient.astro";
import I18nHead from "@astrolicious/i18n/components/I18nHead.astro";

import { getLocale } from "i18n:astro";
import { VISUAL_EDITING_ENABLED } from "@src/consts";

interface Props {
  title: string;
  description: string;
  slug: string;
  siteConfig: SiteConfigQueryResult;
}

const { title, description, slug, siteConfig } = Astro.props;

if (!siteConfig) {
  return new Response(null, { status: 404 });
}

const { data: header } = await loadQuery<NavigationQueryResult>({
  query: navigationQuery,
  params: { navigationId: siteConfig.headerNavigation?._ref! },
});
const { data: footer } = await loadQuery<NavigationQueryResult>({
  query: navigationQuery,
  params: { navigationId: siteConfig.footerNavigation?._ref! },
});

const socials: Social[] | undefined = siteConfig.socials?.map((social) => {
  return {
    name: social.name || "",
    iconImageID: social.icon?.asset?._id || "",
    link: social.link ? getHrefFromLinkObject(social.link, getLocale()) : "",
    alt: social.icon?.asset?.altTexts?.[getLocale()] || "",
  };
});
---

<html class="overflow-x-clip" lang={getLocale().toLowerCase()}>
  <head>
    <meta charset="utf-8" />
    <I18nClient />
    <I18nHead />
    <BaseHead title={title} description={description} />
    {
      slug === "contact" && (
        <link
          rel="preload"
          href="https://js-eu1.hsforms.net/forms/embed/v2.js"
          as="script"
        />
      )
    }
    <Tracking />
  </head>
  <body class="overflow-x-clip bg-blue-800">
    {VISUAL_EDITING_ENABLED && <VisualEditing enabled={true} zIndex={1000} />}

    <Header navigation={header} />
    <main id="main-content" class="mx-auto max-w-[1304px] px-6 sm:px-8">
      <slot />
    </main>
    <Footer
      navigation={header}
      secondaryNavigation={footer}
      footerText={siteConfig.copyrightText}
      socials={socials}
    />
    <TrackingFooter />
  </body>
</html>
