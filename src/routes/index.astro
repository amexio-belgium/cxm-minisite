---
import Base from "@layouts/Base.astro";
import { contentPageQuery, siteConfigQuery } from "@api/queries";
import { loadQuery } from "@api/sanity";
import SanityComponentsRenderer from "@components/cms-components/SanityComponentsRenderer.astro";
import { type ContentPageWithReferences } from "src/sanity/custom.sanity.types";
import HeroHeader from "@components/uicomposition/HeroHeader.astro";
import type { SiteConfigQueryResult } from "@sanity/sanity.types";
import { locales } from "@src/locales/consts";

let siteConfig;
let slug;
let contentPage;

// Remove all forward  slashes from the url
const localeUrl = Astro.url.pathname.replace(/\//g, "");

if (locales.includes(localeUrl)) {
  const { data: siteConfigData } = await loadQuery<SiteConfigQueryResult>({
    query: siteConfigQuery,
    params: { language: localeUrl },
  });
  siteConfig = siteConfigData;
  if (!siteConfig || !siteConfig?.homePage?.slug) {
    return new Response(null, { status: 404 });
  }

  const slug = siteConfig?.homePage?.slug;

  const { data: contentPageData } = await loadQuery<ContentPageWithReferences>({
    query: contentPageQuery,
    params: { language: localeUrl, slug: slug },
  });
  contentPage = contentPageData;
} else {
  return new Response(null, { status: 404 });
}
---

<Base
  title={siteConfig.siteName || ""}
  description={contentPage?.metadata?.description || ""}
  slug={slug!}
  siteConfig={siteConfig}
>
  <HeroHeader
    headline={contentPage.intro?.title}
    text={contentPage.intro?.intro}
    homepage={true}
  />
  <SanityComponentsRenderer content={contentPage?.content} />
</Base>
